<?php
session_start();
///////////////////////////////////////////////////////////////////////////////////////////////////////
//Connection à la base de données
///////////////////////////////////////////////////////////////////////////////////////////////////////
try
{
  $bdd = new PDO(
    'mysql:host=localhost;dbname=db_site;charset=utf8',
    'root',
    '',
    array(PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION));
}
catch (Exception $e)
{
  die('Erreur : ' . $e->getMessage());
}

///////////////////////////////////////////////////////////////////////////////////////////////////////
//variable de redirection si un des champs est faux
///////////////////////////////////////////////////////////////////////////////////////////////////////
$redirect = false;
///////////////////////////////////////////////////////////////////////////////////////////////////////
//Test si le nom est vide
///////////////////////////////////////////////////////////////////////////////////////////////////////
if(isset($_POST['username'])){
  if(empty($_POST['username'])){
    $_SESSION['form_username'] = true;
    $redirect = true;
  }
  else{
    $_SESSION['form_username'] = false;
  }
}
else{
  $_SESSION['form_username'] = true;
  $redirect = true;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////
//Test si le nom est vide
///////////////////////////////////////////////////////////////////////////////////////////////////////
if(isset($_POST['email'])){

    $_SESSION['form_email'] = true;
}
else{
  $redirect = false;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////
//Test si le nom est vide
///////////////////////////////////////////////////////////////////////////////////////////////////////
if(isset($_POST['adress'])){
  if(empty($_POST['adress'])){
    $_SESSION['form_adress'] = true;
    $redirect = true;
  }
  else{
    $_SESSION['form_adress'] = false;
  }
}
else{
  $_SESSION['form_adress'] = true;
  $redirect = true;
}
if($redirect){
  header('Location: admin_edit_user.php?id='.$id);
}
else{
///////////////////////////////////////////////////////////////////////////////////////////////////////
//insertion en base
///////////////////////////////////////////////////////////////////////////////////////////////////////
$admin = '';
if(isset($_POST['admin'])){
  $admin = 'admin';
}
$id = $_SESSION['edit_id'];
$today = date("Y-m-d");
$req = $bdd->prepare('UPDATE users SET username = :username, name = :name, surname = :surname, type = :type, email = :email, phone = :phone, adress = :adress WHERE id_user = :id');

$req->execute(array(
  'username' => htmlspecialchars($_POST['username']),
  'name' => htmlspecialchars($_POST['name']),
  'surname' => htmlspecialchars($_POST['surname']),
	'type' => htmlspecialchars($admin),
  'email' => htmlspecialchars($_POST['email']),
  'phone' => htmlspecialchars($_POST['phone']),
  'adress' => htmlspecialchars($_POST['adress']),
  'id' => $id));
}
header('Location: admin_managment_user.php');
?>
